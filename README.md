## **Patres Test Task**

### **Инстуркция по запуску**

```bash
git clone https://github.com/dima-doroshenko/patres-test-task.git
cd patres-test-task
python -m venv .venv
.venv/scripts/activate
pip install -r requirements.txt
uvicorn src.main:app
```

### **Запуск тестов**

```bash
pytest -v -s
```

### **Структура проекта**

`migration/` - Миграции Alembic

`tests/` - Тесты

  - `conftest.py` - Подготовка БД и фикстуры
  - `test_logic` - Тесты бизнес-логики
  - `test_protected` - Тесты защищенных эндпоинтов с авторизацией и без

`src/` - Директория с кодом

  - `database/` - Модели БД и настройка SQLAlchemy
  - `schemas/` - Часто используемые pydantic-схемы
  - `utils/` - Утилиты (пока что только для аутентификации)
  - `routers/` - ApiRouters приложения. Созданные хэндлеры находятся в `api/v1/`, так как версионирование является одним из принципов `RestAPI`
  - `config.py` - Все настройки проекта
  - `main.py` - Основной файл для запуска приложения

### **Структура базы данных**

**Users**
- `id`
- `email` - Уникальное значение
- `hashed_password` - Хэш пароля 
- `created_at` - `TIMESTAMP` создания пользователя


**Readers**
- `id`
- `name`
- `email` - Уникальное значение


**Books**
- `id`
- `title` - Уникальное значение
- `author`
- `year`
- `isbn` - Уникальное значение
- `amount` - Количество доступных книг (по умолчанию - `1`)

**Borrowed Books**
- `id`
- `book_id` - Внешний ключ `books.id`
- `reader_id` - Внешний ключ `readers.id`
- `borrow_date` - Дата получения книги
- `return_date` - Дата возврата книги (по умолчанию `NULL`) 

Было принято решение создать таблицу `borrowed_books` для оргагизации `many-to-many` связи. В нее записываются идентификаторы книги и читателя, дата взятия книги. При возвращении книги в `return_date` записывается текущая дата

### **Бизнес логика**

- **Бизнес-логика 1**: *Книгу можно выдать, только если есть доступные экземпляры* 

  При выдаче книг пользователю проверяется, есть ли эта книга(с помощью колонки `books.amount`), если ее нет, то вызывается исключение

- **Бизнес-логика 2**: *Один читатель не может взять более 3-х книг одновременно*

  При выдаче книг проверяются все записи, в которыз фигурирует его `id`, и `return_date` равно `NULL` (значит, что книга не возвращена). Если число полученных записей больше 3, вызывается исключение

- **Бизнес-логика 3**: *Нельзя вернуть книгу, которая не была выдана этому читателю или уже возвращена*

  Из `borrowed_books` выбираются записи, в которых находятся переданные `reader_id` и `book_id`, и в которых `return_date` равно `NULL`. Если таких записей не существует, то вызывается исключение, в котором указано, что пользователь не брал эту книгу или уже вернул ее. Если же запись существует, то она обновляется, изменяя `return_date` на текущую дату. Число доступных книг увеличивается на 1

### **Аутентификация и авторизация**

Реализована с помощью библиотеки `pyjwt`

`HTTPBearer` - зависимость вынесена на высший уровень, чтобы не допустить создания незащищенных эндпоинтов

В `src/utils/auth/` реализованы функции для создание `access` и `refresh` токенов, их декодирования

При передаче токена в заголовках он обрабатывается в `UserGetterFromToken`, где проверяется тип токена, далее пользователь достается из БД по `id`, полученному в `sub`, и передается в зависимость

Для создания токенов существуют функции `create_access_token` и `create_refresh_token`. На вход они принимают модели пользователей из БД, в `sub` передают идентификатор пользователя, указывают `typ` - тип токена, согласно названию функции, и возвращают токен в виде строки

Защищены все эндпоинты, так как приложение предназначено только для внутреннего использования. Несанкционированный доступ может повлечь утечку данных и излишнюю нагрузку на сервер

### **Творческая часть**

Так как история прочитанных книг сохраняется, то можно реализовать функционал рекомендации книг с помощью ИИ. Ему будет передаваться список прочитанных книг, и на его основе он сможет советовать книги читателю

Данную фичу можно реализовать с помощью уже созданных LLM, поэтому собственные ML-инженеры не понадобятся